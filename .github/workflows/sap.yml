name: sap

on:
  push:
    branches:
      - sap
  # schedule:
  #   - cron: "01,20 0 * * *"
  workflow_dispatch:

jobs:
  deploy:
    timeout-minutes: 20
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        ACCOUNT_SECRET: ${{ fromJSON(vars.SAP) }}
    steps:
      - name: Setup Cloud Foundry CLI
        run: |
          version=$(curl -s https://api.github.com/repos/cloudfoundry/cli/releases/latest | jq -r .tag_name)
          filename="cf8-cli_${version#v}_linux_x86-64.tgz"
          url="https://github.com/cloudfoundry/cli/releases/download/${version}/${filename}"
          echo "Downloading CF CLI: $url"
          curl -fLO "$url" || { echo "ä¸‹è½½å¤±è´¥"; exit 1; }
          file "$filename" | grep -q 'gzip compressed data' || { echo "æ–‡ä»¶æ ¼å¼é”™è¯¯"; exit 1; }
          tar -xzf "$filename"
          chmod +x cf8

      - name: Deploy Single Application from manifest
        shell: bash
        run: |
          CF_VERBOSE=false
          echo "ğŸ”§ CF_VERBOSE=$CF_VERBOSE â†’ $( [ "$CF_VERBOSE" = true ] && echo 'æ˜¾ç¤ºè¯¦ç»†æ—¥å¿—' || echo 'é™é»˜æ¨¡å¼' )"

          run_cf() {
            if [ "$CF_VERBOSE" = true ]; then
              ./cf8 "$@"
            else
              ./cf8 "$@" >/dev/null 2>&1
            fi
          }

          # æå–åŸºç¡€ä¿¡æ¯
          CONFIG_JSON='${{ secrets[matrix.ACCOUNT_SECRET] }}'
          CF_API=$(echo "$CONFIG_JSON" | jq -r '.region_api')
          EMAIL=$(echo "$CONFIG_JSON" | jq -r '.credentials.email')
          PASSWORD=$(echo "$CONFIG_JSON" | jq -r '.credentials.password')
          REPO_URL=$(echo "$CONFIG_JSON" | jq -r '.repo_url')
          MANIFEST_B64=$(echo "$CONFIG_JSON" | jq -r '.manifest')
          CFIGNORE_B64=$(echo "$CONFIG_JSON" | jq -r '.cfignore // empty')

          echo "::add-mask::$EMAIL"
          echo "::add-mask::$PASSWORD"

          echo "ğŸ“ å†™å…¥ manifest.yml"
          echo "$MANIFEST_B64" | base64 -d > manifest.yml
          APP_NAME=$(yq e '.applications[0].name' manifest.yml)

          echo "ğŸ” Logging in to Cloud Foundry..."
          run_cf login -a "$CF_API" -u "$EMAIL" -p "$PASSWORD" || { echo "âŒ ç™»å½•å¤±è´¥"; exit 1; }

          echo "ğŸ”„ ä¿æ´»å¤„ç†: $APP_NAME"

          if run_cf app "$APP_NAME"; then
            echo "å°è¯•å¯åŠ¨å·²å­˜åœ¨åº”ç”¨: $APP_NAME"
            if run_cf start "$APP_NAME"; then
              echo "âœ… å¯åŠ¨æˆåŠŸ: $APP_NAME"
              exit 0
            else
              echo "âš ï¸ å¯åŠ¨å¤±è´¥ï¼Œå°è¯•é‡æ–°éƒ¨ç½²: $APP_NAME"
            fi
          else
            echo "ğŸ“¦ åº”ç”¨ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°å®ä¾‹: $APP_NAME"
          fi

          echo "ğŸ“¦ å…‹éš†ä»“åº“"
          git clone --depth=1 "$REPO_URL" app || { echo "âŒ å…‹éš†å¤±è´¥"; exit 1; }

          echo "ğŸ“„ ç§»åŠ¨ manifest.yml åˆ° app/"
          mv manifest.yml app/manifest.yml

          if [ -n "$CFIGNORE_B64" ]; then
            echo "ğŸ“„ å†™å…¥ .cfignore åˆ° app/"
            echo "$CFIGNORE_B64" | base64 -d > app/.cfignore
          fi

          echo "ğŸš€ æ‰§è¡Œ cf push \"$APP_NAME\" -f app/manifest.yml -p app"
          if run_cf push "$APP_NAME" -f app/manifest.yml -p app; then
            echo "âœ… éƒ¨ç½²æˆåŠŸ: $APP_NAME"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥: $APP_NAME"
            exit 1
          fi

